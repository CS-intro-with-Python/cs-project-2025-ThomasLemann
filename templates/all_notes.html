{% extends "base.html" %}

{% block content %}

<form action="/" method="GET" style="display:inline;">
    <button id="goHome">Home</button>
</form>

<h2>All Notes by {{ session.get('email') }}</h2>

<form method="GET" action="{{ url_for('all_notes') }}" id="searchForm" style="margin: 15px 0;">

    <!-- ðŸ” Search by title -->
    <input
        type="text"
        name="q"
        placeholder="Search by title..."
        value="{{ search_query }}"
        style="padding:5px; width:200px;"
    >

    <br><br>

    <!-- ðŸ· Tags -->
    <div id="tagsContainer">
        {% if tags %}
            {% for tag in tags %}
                <input
                    type="text"
                    name="tags[]"
                    value="{{ tag }}"
                    placeholder="Tag"
                    style="padding:5px; width:120px; margin-right:5px;"
                >
            {% endfor %}
        {% else %}
            <input
                type="text"
                name="tags[]"
                placeholder="Tag"
                style="padding:5px; width:120px; margin-right:5px;"
            >
        {% endif %}
    </div>

    <button type="button" onclick="addTagField()">+</button>

    <br><br>

    <button type="submit">Search</button>
    <button type="button" onclick="clearFilters()">Clear</button>

</form>

<!-- ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð·Ð°Ð¼ÐµÑ‚Ð¾Ðº -->
<div id="notesContainer" style="display:flex; flex-wrap: wrap; margin-top:20px;">
    {% if notes %}
        {% for note in notes %}
        <div class="noteItem" id="note-{{ note.id }}" style="margin:10px; text-align:center; border:1px solid #ccc; padding:10px;">
            {% if note.header %}
                <h3 style="max-width:200px; word-wrap:break-word;">{{ note.header }}</h3>
            {% endif %}

            <p style="max-width:200px; word-wrap: break-word;">
                {% if note.tags %}
                    {% set tag_list = note.tags.split(',') %}
                    {% set tag_strs = [] %}
                    {% for tag in tag_list %}
                        {% if tag.strip() %}
                            {% set _ = tag_strs.append('#' ~ tag.strip()) %}
                        {% endif %}
                    {% endfor %}
                    {% set tag_str = tag_strs | join(', ') %}
                    {% if tag_str|length > 50 %}
                        {{ tag_str[:50] }}...
                    {% else %}
                        {{ tag_str }}
                    {% endif %}
                {% endif %}
            </p>

            <img src="{{ note.img }}" width="200">

            <p style="max-width:200px; word-wrap: break-word;">
                {% if note.text and note.text|length > 50 %}
                    {{ note.text[:50] }}...
                {% else %}
                    {{ note.text }}
                {% endif %}
            </p>

            <div style="margin-top:5px;">
                <a href="{{ url_for('note', note_id=note.id) }}"><button type="button">Edit</button></a>
                <button type="button" onclick="deleteNote({{ note.id }})">Delete</button>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <p>No saved notes yet.</p>
    {% endif %}
</div>

<a href="{{ url_for('note') }}">
    <button>Write a new note</button>
</a>

<script>
function addTagField() {
    const container = document.getElementById("tagsContainer");
    const input = document.createElement("input");
    input.type = "text";
    input.name = "tags[]";
    input.placeholder = "Tag";
    input.style.padding = "5px";
    input.style.width = "120px";
    input.style.marginRight = "5px";
    container.appendChild(input);
}

// AJAX-Ð¿Ð¾Ð¸ÑÐº
document.getElementById("searchForm").addEventListener("submit", function(e) {
    e.preventDefault();
    fetchNotes();
});

function fetchNotes() {
    const form = document.getElementById("searchForm");
    const formData = new FormData(form);
    const params = new URLSearchParams(formData);

    fetch(`/all_notes?${params.toString()}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById("notesContainer");
        container.innerHTML = "";

        if (data.length === 0) {
            container.innerHTML = "<p>No saved notes found.</p>";
            return;
        }

        data.forEach(note => {
            let tagStr = "";
            if (note.tags) {
                const tagsArr = note.tags.split(",").map(t => "#" + t.trim()).filter(t => t !== "#");
                tagStr = tagsArr.join(", ");
                if (tagStr.length > 50) tagStr = tagStr.slice(0, 50) + "...";
            }

            let textPreview = note.text || "";
            if (textPreview.length > 50) textPreview = textPreview.slice(0, 50) + "...";

            const noteDiv = document.createElement("div");
            noteDiv.className = "noteItem";
            noteDiv.style = "margin:10px; text-align:center; border:1px solid #ccc; padding:10px;";
            noteDiv.innerHTML = `
                ${note.header ? `<h3 style="max-width:200px; word-wrap:break-word;">${note.header}</h3>` : ""}
                <p style="max-width:200px; word-wrap: break-word;">${tagStr}</p>
                <img src="${note.img}" width="200">
                <p style="max-width:200px; word-wrap: break-word;">${textPreview}</p>
                <div style="margin-top:5px;">
                    <a href="/note/${note.id}"><button type="button">Edit</button></a>
                    <form method="POST" action="/delete_note" style="display:inline;">
                        <input type="hidden" name="note_id" value="${note.id}">
                        <button type="submit">Delete</button>
                    </form>
                </div>
            `;
            container.appendChild(noteDiv);
        });
    })
    .catch(err => console.error(err));
}

function clearFilters() {
    const form = document.getElementById("searchForm");

    // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð¿Ð¾Ð¸ÑÐºÐ°
    form.querySelector("input[name='q']").value = "";

    // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²ÑÐµ Ð¿Ð¾Ð»Ñ Ñ‚ÐµÐ³Ð¾Ð² ÐºÑ€Ð¾Ð¼Ðµ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾
    const tagInputs = form.querySelectorAll("input[name='tags[]']");
    tagInputs.forEach((input, idx) => {
        if (idx === 0) input.value = "";
        else input.remove();
    });

    // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð·Ð°Ð¼ÐµÑ‚ÐºÐ¸ Ð±ÐµÐ· Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð²
    fetchNotes();
}
function deleteNote(noteId) {
    if (!confirm("Are you sure you want to delete this note?")) return;

    fetch("/delete_note", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-Requested-With": "XMLHttpRequest"
        },
        body: `note_id=${noteId}`
    })
    .then(response => {
        if (response.ok) {
            // Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ Ð¸Ð· DOM
            const noteDiv = document.getElementById(`note-${noteId}`);
            if (noteDiv) noteDiv.remove();
        } else {
            console.error("Failed to delete note");
        }
    })
    .catch(err => console.error(err));
}
</script>

{% endblock %}

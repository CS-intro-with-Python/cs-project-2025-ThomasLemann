{% extends "base.html" %}

{% block content %}

<p>Write your notes here:</p>
<div style="position: relative; width: 800px; height: 600px;">
    <canvas id="drawingCanvas" width="800" height="600"
            style="border:1px solid #000; position:absolute; left:0; top:0;"></canvas>

    <canvas id="cursorCanvas" width="800" height="600"
            style="position:absolute; left:0; top:0; pointer-events:none;"></canvas>
</div>
<p>
    Color: <input type="color" id="colorPicker" value="#000000"> <br>
    Width: <input type="range" id="brushSize" min="1" max="40" value="5">
</p>
<button id="eraserBtn">Eraser</button>
<button id="penBtn">Pen</button> <br>
<button id="clearBtn">Clear</button> <br>

<p>Optional Text for Note:</p>

<form method="POST" id="saveForm">
    <textarea id="textNote" name="textNote" rows="4" cols="50">{{ text_note }}</textarea> <br>
    <input type="hidden" name="imageData" id="imageData">
    <input type="hidden" name="originalFilename" value="{{ original_filename or '' }}">
    <button type="submit" id="saveBtn">Save Note</button>
</form> <hr>

<a href="{{ url_for('all_notes') }}"><button>All notes</button></a>

<script>
const canvas = document.getElementById("drawingCanvas");
const ctx = canvas.getContext("2d");

const cursorCanvas = document.getElementById("cursorCanvas");
const cursorCtx = cursorCanvas.getContext("2d");

const colorPicker = document.getElementById("colorPicker");
const brushSize = document.getElementById("brushSize");
const eraserBtn = document.getElementById("eraserBtn");
const penBtn = document.getElementById("penBtn");
const clearBtn = document.getElementById("clearBtn");
const saveForm = document.getElementById("saveForm");

let drawing = false;
let isEraser = false;

{% if image_data %}
let img = new Image();
img.onload = function() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0);
};
img.src = "{{ image_data }}";
{% endif %}

canvas.addEventListener("mousedown", (e) => {
    drawing = true;
    ctx.beginPath();
    ctx.moveTo(e.offsetX, e.offsetY);
});

canvas.addEventListener("mousemove", (e) => {
    const x = e.offsetX;
    const y = e.offsetY;
    const size = brushSize.value;

    cursorCtx.clearRect(0, 0, cursorCanvas.width, cursorCanvas.height);

    if (isEraser) {
        cursorCtx.strokeStyle = "black";
        cursorCtx.lineWidth = 1;
        cursorCtx.beginPath();
        cursorCtx.arc(x, y, size / 2, 0, Math.PI * 2);
        cursorCtx.stroke();
    }

    if (!drawing) return;

    if (isEraser) {
        ctx.beginPath();
        ctx.arc(x, y, size / 2, 0, Math.PI * 2);
        ctx.fill();
    } else {
        ctx.strokeStyle = colorPicker.value;
        ctx.lineWidth = size;
        ctx.lineCap = "round";
        ctx.lineTo(x, y);
        ctx.stroke();
    }
});

canvas.addEventListener("mouseup", () => drawing = false);
canvas.addEventListener("mouseleave", () => drawing = false);

eraserBtn.addEventListener("click", () => {
    isEraser = true;
    ctx.globalCompositeOperation = "destination-out";
});

penBtn.addEventListener("click", () => {
    isEraser = false;
    ctx.globalCompositeOperation = "source-over";
});

clearBtn.addEventListener("click", () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
});

saveForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const imageData = canvas.toDataURL("image/png");
    document.getElementById("imageData").value = imageData;
    saveForm.submit();
});
</script>

{% endblock %}